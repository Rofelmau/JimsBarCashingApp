name: Build Qt Application for Raspberry Pi 5

on:
  push:
    branches:
      - '**'

jobs:
  build:
    name: Build Application for arm64
    runs-on: ubuntu-latest

    steps:
      # Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Docker Buildx einrichten f端r Cross-Architektur-Builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # QEMU-Emulation f端r ARM64 aktivieren
      - name: Set QEMU for ARM64 Emulation
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      # Docker-Image f端r ARM64 laden und vorbereiten
      - name: Pull Multi-Platform Docker Image and Start Build
        run: |
          # Docker-Image f端r arm64 explizit starten
          docker run --rm --platform linux/arm64 -v $(pwd):/workspace -w /workspace carlonluca/qt-dev:5.15.2 /bin/bash -c "
          # sqlite3, cmake, und make installieren falls notwendig
          apt-get update && apt-get install -y sqlite3 && \
          mkdir -p build && cd build && \
          cmake .. -DCMAKE_BUILD_TYPE=Release && \
          make -j$(nproc)
          "

      # Bau-Artefakte hochladen
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MyProject-RaspberryPi
          path: build/src/MyProject

      # Log-Dateien hochladen
      - name: Upload Logs
        uses: actions/upload-artifact@v4
        with:
          name: Build-Logs
          path: |
            build/*.txt