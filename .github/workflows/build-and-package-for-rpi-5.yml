name: Build Qt Application for Raspberry Pi 5

on:
  push:
    branches:
      - '**'

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Build in arm64 container
        uses: uraimo/run-on-arch-action@v3.0.0
        with:
          arch: aarch64
          base_image: carlonluca/qt-dev:5.15.2
          install: |
            apt-get update
            apt-get install -y sqlite3 qt5-qmake qtbase5-dev qtchooser qtbase5-dev-tools
          run: |
            # Setze den Pfad für ARM Qt-Bibliotheken
            export PATH=/opt/Qt-arm64-5.15.2/bin:$PATH
            export QT_LIBRARY_PATH=/opt/Qt-arm64-5.15.2/lib:$QT_LIBRARY_PATH
            export LD_LIBRARY_PATH=/opt/Qt-arm64-5.15.2/lib:$LD_LIBRARY_PATH

            # Überprüfe, ob die ARM-Version von moc verwendet wird
            which moc
            echo "QT_LIBRARY_PATH: $QT_LIBRARY_PATH"
            echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"

            # Build-Prozess
            export ARCH=aarch64
            mkdir -p build
            cd build
            cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_SYSTEM_NAME=Linux -DCMAKE_SYSTEM_PROCESSOR=${ARCH} 2>&1 | tee ../cmake_config_log.txt
            make -j$(nproc) 2>&1 | tee ../make_build_log.txt

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MyProject-RaspberryPi
          path: build/src/MyProject